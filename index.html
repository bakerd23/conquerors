<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Conquerors Basketball Gameday</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <style>
    html,body{margin:0;padding:0;height:100%}
    .dark-mode{background-color:#111827!important}
    .light-mode{background-color:#f9fafb!important}
    .animate-pulse{animation:pulse 2s cubic-bezier(.4,0,.6,1) infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
  </style>
</head>
<body class="dark-mode">
  <div id="root"></div>

  <script type="text/babel">
    const {useState, useCallback, useEffect} = React;

    const firebaseConfig = {
      apiKey: "AIzaSyCGk-hxgCxmFEC3p66gMDZp2VF7wd88XqI",
      authDomain: "conquerors-shooting.firebaseapp.com",
      projectId: "conquerors-shooting",
      storageBucket: "conquerors-shooting.firebasestorage.app",
      messagingSenderId: "1094564414431",
      appId: "1:1094564414431:web:8883a3bb1a136bb920ba6a"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    auth.onAuthStateChanged(u => { if (!u) auth.signInAnonymously().catch(console.error); });

    const players = [
      { id: 1,  number: 1,  firstName: "Gabriel"},
      { id: 2,  number: 2,  firstName: "Josiah"},
      { id: 3,  number: 3,  firstName: "Mason"},
      { id: 4,  number: 4,  firstName: "Gabe"},
      { id: 12, number: 12, firstName: "Kale"},
      { id: 15, number: 15, firstName: "Machen"},
      { id: 20, number: 20, firstName: "James"},
      { id: 22, number: 22, firstName: "Charlie"},
      { id: 23, number: 23, firstName: "Rylan"},
      { id: 33, number: 33, firstName: "Zach"},
      { id: 35, number: 35, firstName: "Seth"},
      { id: 40, number: 40, firstName: "Cole"},
      { id: 41, number: 41, firstName: "Bradley"},
      { id: 51, number: 51, firstName: "Titus"},
    ];

    const SHOT_CATEGORIES = {
      "Makes": ["Layup", "Extended Finish", "2 Jumpshot", "3 Jumpshot", "Free Throw"],
      "Misses": ["Layup", "Extended Finish", "2 Jumpshot", "3 Jumpshot", "Free Throw"]
    };

    const TEAM_STATS = ["Offensive Rebound", "Defensive Rebound", "Turnover"];

    const App = () => {
      const [gameDate, setGameDate] = useState(new Date().toISOString().split('T')[0]);
      const [opponent, setOpponent] = useState('');
      const [selectedPlayer, setSelectedPlayer] = useState(null);
      const [playerStats, setPlayerStats] = useState({});
      const [teamStats, setTeamStats] = useState({});
      const [saveStatus, setSaveStatus] = useState('saved');
      const [darkMode, setDarkMode] = useState(true);
      const [activeTab, setActiveTab] = useState('shots');

      useEffect(() => { document.body.className = darkMode ? 'dark-mode' : 'light-mode'; }, [darkMode]);

      const getGameId = () => `${gameDate}-${opponent.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase()}`;
      const getPlayerKey = (id) => `${getGameId()}-p${id}`;
      const getTeamKey = () => `${getGameId()}-team`;
      const getStatValue = useCallback((id, cat, stat) => playerStats[getPlayerKey(id)]?.[`${cat}:${stat}`] || 0, [playerStats, gameDate, opponent]);
      const getTeamStatValue = useCallback((side, stat) => teamStats[getTeamKey()]?.[`${side}:${stat}`] || 0, [teamStats, gameDate, opponent]);

      const loadExisting = useCallback(async () => {
        if (!opponent) return;
        try {
          const gameId = getGameId();
          const docRef = db.collection('gameSummaries').doc(gameId);
          const snap = await docRef.get();
          if (!snap.exists) { setPlayerStats({}); setTeamStats({}); return; }
          const data = snap.data();

          const loadedPlayers = {};
          Object.entries(data.playerStats || {}).forEach(([k, stats]) => {
            const id = parseInt(k.replace('player_', ''), 10);
            loadedPlayers[getPlayerKey(id)] = { ...stats };
          });
          setPlayerStats(loadedPlayers);

          const loadedTeam = {};
          if (data.teamStats) {
            loadedTeam[getTeamKey()] = { ...data.teamStats };
          }
          setTeamStats(loadedTeam);
        } catch (e) { console.error(e); }
      }, [gameDate, opponent]);

      useEffect(() => { loadExisting(); }, [loadExisting]);

      const saveEvent = useCallback(async (ev) => {
        try {
          setSaveStatus('saving');
          const gameId = getGameId();

          await db.collection('gameEvents').add({
            ...ev,
            gameId,
            gameDate,
            opponent,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });

          const docRef = db.collection('gameSummaries').doc(gameId);
          const snap = await docRef.get();

          if (ev.eventType === 'shot') {
            const playerKey = `player_${ev.playerId}`;
            const statKey = `${ev.category}:${ev.stat}`;

            if (snap.exists) {
              const current = snap.data();
              const curPlayer = current.playerStats?.[playerKey] || {};
              const newVal = Math.max(0, (curPlayer[statKey] || 0) + ev.change);
              await docRef.update({
                [`playerStats.${playerKey}.${statKey}`]: newVal,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
              });
            } else {
              await docRef.set({
                gameDate,
                opponent,
                gameId,
                playerStats: { [playerKey]: { [statKey]: Math.max(0, ev.change) } },
                teamStats: {},
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
              });
            }
          } else if (ev.eventType === 'team') {
            const statKey = `${ev.side}:${ev.stat}`;
            if (snap.exists) {
              const current = snap.data();
              const curTeam = current.teamStats || {};
              const newVal = Math.max(0, (curTeam[statKey] || 0) + ev.change);
              await docRef.update({
                [`teamStats.${statKey}`]: newVal,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
              });
            } else {
              await docRef.set({
                gameDate,
                opponent,
                gameId,
                playerStats: {},
                teamStats: { [statKey]: Math.max(0, ev.change) },
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
              });
            }
          }

          setSaveStatus('saved');
        } catch (e) {
          console.error('Firestore error', e.code, e.message);
          setSaveStatus('error');
          setTimeout(() => setSaveStatus('saved'), 3000);
        }
      }, [gameDate, opponent]);

      const updateStat = useCallback((id, cat, stat, delta) => {
        if (!opponent) return;
        const key = getPlayerKey(id);
        setPlayerStats(prev => {
          const next = { ...prev };
          next[key] = { ...(next[key] || {}) };
          const sKey = `${cat}:${stat}`;
          const cur = next[key][sKey] || 0;
          next[key][sKey] = Math.max(0, cur + delta);
          return next;
        });
        const p = players.find(x => x.id === id) || {};
        const ev = {
          eventType: 'shot',
          gameDate,
          opponent,
          playerId: id,
          playerNumber: p.number || String(id),
          firstName: p.firstName || '',
          category: cat,
          stat,
          change: delta,
          timestamp: new Date().toISOString()
        };
        saveEvent(ev);
      }, [gameDate, opponent, saveEvent]);

      const updateTeamStat = useCallback((side, stat, delta) => {  
        if (!opponent) return;
        const key = getTeamKey();
        setTeamStats(prev => {
          const next = { ...prev };
          next[key] = { ...(next[key] || {}) };
          const sKey = `${side}:${stat}`;
          const cur = next[key][sKey] || 0;
          next[key][sKey] = Math.max(0, cur + delta);
          return next;
        });
        const ev = {
          eventType: 'team',
          gameDate,
          opponent,
          side,
          stat,
          change: delta,
          timestamp: new Date().toISOString()
        };
        saveEvent(ev);
      }, [gameDate, opponent, saveEvent]);

      const Status = () => {
        const map = {
          saving: { color: 'text-yellow-600', dot: 'bg-yellow-500', text: 'Saving‚Ä¶' },
          error:  { color: 'text-red-600',    dot: 'bg-red-500',    text: 'Save error' },
          saved:  { color: 'text-green-600',  dot: 'bg-green-500',  text: 'Saved to cloud' }
        }[saveStatus];
        return (
          <div className={`flex items-center gap-2 text-sm ${map.color} min-w-32`}>
            <div className={`w-2 h-2 ${map.dot} rounded-full ${saveStatus==='saving' ? 'animate-pulse':''}`}></div>
            <span>{map.text}</span>
          </div>
        );
      };

      const StatRow = ({ id, cat, stat }) => {
        const v = getStatValue(id, cat, stat);
        const isMiss = cat === 'Misses';
        return (
          <div className={`flex items-center justify-between p-3 rounded-lg border ${
            isMiss
              ? (darkMode ? 'bg-red-900/50 border-red-800' : 'bg-red-50 border-red-200')
              : (darkMode ? 'bg-green-900/50 border-green-800' : 'bg-green-50 border-green-200')
          }`}>
            <div className={`text-sm font-medium ${
              isMiss ? (darkMode ? 'text-red-300' : 'text-red-800')
                     : (darkMode ? 'text-green-300' : 'text-green-800')
            }`}>{stat}</div>
            <div className="flex items-center gap-2">
              <button
                onClick={() => updateStat(id, cat, stat, -1)}
                disabled={v===0 || !opponent}
                className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-white ${
                  v===0 || !opponent
                    ? 'bg-gray-300 cursor-not-allowed'
                    : (isMiss
                        ? 'bg-green-500 hover:bg-green-600 active:bg-green-700'
                        : 'bg-red-500 hover:bg-red-600 active:bg-red-700')
                }`}
              >‚àí</button>

              <div className={`w-12 text-center font-bold text-lg ${
                isMiss ? (darkMode ? 'text-red-300' : 'text-red-700')
                       : (darkMode ? 'text-green-300' : 'text-green-700')
              }`}>{v}</div>

              <button
                onClick={() => updateStat(id, cat, stat, 1)}
                disabled={!opponent}
                className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-white ${
                  !opponent
                    ? 'bg-gray-300 cursor-not-allowed'
                    : (isMiss
                        ? 'bg-red-500 hover:bg-red-600 active:bg-red-700'
                        : 'bg-green-500 hover:bg-green-600 active:bg-green-700')
                }`}
              >+</button>
            </div>
          </div>
        );
      };

      const TeamStatRow = ({ side, stat }) => {
        const v = getTeamStatValue(side, stat);
        const isConquerors = side === 'Conquerors';
        return (
          <div className={`flex items-center justify-between p-3 rounded-lg border ${isConquerors
            ? (darkMode ? 'bg-purple-900/50 border-purple-800' : 'bg-purple-50 border-purple-200')
            : (darkMode ? 'bg-orange-900/50 border-orange-700' : 'bg-orange-50 border-orange-200')}`}>
            <div className={`text-sm font-medium ${isConquerors
              ? (darkMode ? 'text-purple-300' : 'text-purple-800')
              : (darkMode ? 'text-orange-300' : 'text-orange-800')}`}>{stat}</div>
            <div className="flex items-center gap-2">
              <button onClick={() => updateTeamStat(side, stat, -1)} disabled={v===0 || !opponent}
                className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-white ${v===0 || !opponent
                  ? 'bg-gray-300 cursor-not-allowed'
                  : (isConquerors
                      ? 'bg-purple-500 hover:bg-purple-600 active:bg-purple-700'
                      : 'bg-orange-400 hover:bg-orange-500 active:bg-orange-700')}`}>‚àí</button>

              <div className={`${isConquerors
                ? (darkMode ? 'text-purple-300' : 'text-purple-700')
                : (darkMode ? 'text-orange-300' : 'text-orange-700')} w-12 text-center font-bold text-lg`}>{v}</div>

              <button onClick={() => updateTeamStat(side, stat, 1)} disabled={!opponent}
                className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-white ${!opponent
                  ? 'bg-gray-300 cursor-not-allowed'
                  : (isConquerors
                      ? 'bg-purple-500 hover:bg-purple-600 active:bg-purple-700'
                      : 'bg-orange-400 hover:bg-orange-500 active:bg-orange-700')}`}>+</button>
            </div>
          </div>
        );
      };

      return (
        <div className="max-w-6xl mx-auto p-4 min-h-screen">
          <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow-md p-6 mb-6`}>
            <div className="flex flex-col gap-4">
              <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
                <div>
                  <h1 className={`${darkMode ? 'text-white' : 'text-gray-800'} text-2xl font-bold`}>Game Input ‚Äî Makes/Misses</h1>
                  <div className={`${darkMode ? 'text-gray-500' : 'text-gray-400'} text-xs`}>v1.3 - Fixed</div>
                </div>
                <div className="flex items-center gap-4">
                  <a href="game-stats-viewer.html"
                     className={`${darkMode ? 'bg-purple-600 hover:bg-purple-700 text-white' : 'bg-purple-500 hover:bg-purple-600 text-white'} px-4 py-2 rounded-md font-medium transition-colors`}>
                    View Stats ‚Üí
                  </a>
                  <button onClick={() => setDarkMode(p=>!p)}
                    className={`${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'} px-3 py-2 rounded-md`}>
                    {darkMode ? '‚òÄÔ∏è Light' : 'üåô Dark'}
                  </button>
                  <Status />
                </div>
              </div>

              <div className="flex flex-col sm:flex-row gap-4">
                <div className="flex items-center gap-2 flex-1">
                  <label className={`${darkMode ? 'text-gray-300' : 'text-gray-700'} text-sm font-medium whitespace-nowrap`}>Game Date:</label>
                  <input type="date" value={gameDate} onChange={e=>setGameDate(e.target.value)}
                    className={`${darkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white text-gray-900'} px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 flex-1`} />
                </div>

                <div className="flex items-center gap-2 flex-1">
                  <label className={`${darkMode ? 'text-gray-300' : 'text-gray-700'} text-sm font-medium whitespace-nowrap`}>Opponent:</label>
                  <input type="text" value={opponent} onChange={e=>setOpponent(e.target.value)} placeholder="Enter opponent name"
                    className={`${darkMode ? 'border-gray-600 bg-gray-700 text-white placeholder-gray-400' : 'border-gray-300 bg-white text-gray-900 placeholder-gray-500'} px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 flex-1`} />
                </div>
              </div>
            </div>
          </div>

          {!opponent ? (
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow-md p-12 text-center`}>
              <div className={`${darkMode ? 'text-gray-400' : 'text-gray-500'} text-lg`}>Enter opponent name to start tracking</div>
            </div>
          ) : (
            <>
              <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow-md p-6 mb-6`}>
                <div className="flex gap-2 mb-4">
                  <button onClick={() => setActiveTab('shots')}
                    className={`flex-1 py-3 rounded-lg font-semibold transition-all ${activeTab === 'shots'
                      ? (darkMode ? 'bg-purple-600 text-white' : 'bg-purple-500 text-white')
                      : (darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-100 text-gray-700 hover:bg-gray-200')}`}>
                    Player Shots
                  </button>

                  <button onClick={() => setActiveTab('team')}
                    className={`flex-1 py-3 rounded-lg font-semibold transition-all ${activeTab === 'team'
                      ? (darkMode ? 'bg-purple-600 text-white' : 'bg-purple-500 text-white')
                      : (darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-100 text-gray-700 hover:bg-gray-200')}`}>
                    Rebs/TOs
                  </button>
                </div>

                {activeTab === 'shots' && (
                  <>
                    <h2 className={`${darkMode ? 'text-white' : 'text-gray-800'} text-xl font-semibold mb-4`}>Select Player</h2>
                    <div className="grid grid-cols-7 gap-3">
                      {players.map(p => (
                        <button key={p.id} onClick={() => setSelectedPlayer(p.id)}
                          className={`p-4 rounded-lg border-2 transition-all font-semibold text-lg ${selectedPlayer===p.id
                            ? 'border-purple-500 bg-purple-100 text-purple-800 shadow-md scale-105'
                            : (darkMode ? 'border-gray-600 bg-gray-700 text-gray-200 hover:border-gray-500 hover:bg-gray-600'
                                        : 'border-gray-200 bg-white text-gray-700 hover:border-gray-300 hover:bg-gray-50')}`}>
                          <div className="text-2xl font-bold">{p.number}</div>
                          <div className="text-sm">{p.firstName}</div>
                        </button>
                      ))}
                    </div>
                  </>
                )}

                {activeTab === 'team' && (
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div className="space-y-3">
                      <h3 className={`${darkMode ? 'bg-purple-700 text-purple-100' : 'bg-purple-100 text-purple-800'} text-lg font-semibold text-center py-2 px-4 rounded-lg`}>Conquerors</h3>
                      {TEAM_STATS.map(stat => (
                        <TeamStatRow key={`conq-${stat}`} side="Conquerors" stat={stat} />
                      ))}
                    </div>

                    <div className="space-y-3">
                      <h3 className={`${darkMode ? 'bg-orange-600 text-orange-100' : 'bg-orange-100 text-orange-800'} text-lg font-semibold text-center py-2 px-4 rounded-lg`}>Opponent</h3>
                      {TEAM_STATS.map(stat => (
                        <TeamStatRow key={`opp-${stat}`} side="Opponent" stat={stat} />
                      ))}
                    </div>
                  </div>
                )}
              </div>

              {activeTab === 'shots' && selectedPlayer !== null && (
                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow-md p-6`}>
                  <h2 className={`${darkMode ? 'text-white' : 'text-gray-800'} text-xl font-semibold mb-4`}>
                    Stats for {players.find(x=>x.id===selectedPlayer)?.firstName}
                  </h2>
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    {Object.entries(SHOT_CATEGORIES).map(([cat, stats]) => (
                      <div key={cat} className="space-y-3">
                        <h3 className={`${darkMode ? 'bg-gray-700 text-gray-200' : 'bg-gray-100 text-gray-800'} text-lg font-semibold text-center py-2 px-4 rounded-lg`}>{cat}</h3>
                        {stats.map(stat => (
                          <StatRow key={`${cat}-${stat}`} id={selectedPlayer} cat={cat} stat={stat} />
                        ))}
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {activeTab === 'shots' && selectedPlayer === null && (
                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow-md p-12 text-center`}>
                  <div className={`${darkMode ? 'text-gray-400' : 'text-gray-500'} text-lg`}>Select a player to start</div>
                </div>
              )}
            </>
          )}
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
